<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../static/layuiadmin/layui/css/layui.css"
          th:href="@{/layuiadmin/layui/css/layui.css}"
          media="all">
    <link rel="stylesheet" href="../../../static/layuiadmin/style/admin.css"
          th:href="@{/layuiadmin/style/admin.css}"
          media="all">
    <link rel="stylesheet" href="../../../static/zTree_v3/css/demo.css"
          th:href="@{/zTree_v3/css/demo.css}"
          media="all">
    <link rel="stylesheet" href="../../../static/zTree_v3/css/zTreeStyle/zTreeStyle.css"
          th:href="@{/zTree_v3/css/zTreeStyle/zTreeStyle.css}"
          media="all">
</head>
<body>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 15px;">
            <div style="margin: 0 auto;" class="zTreeDemoBackground left">
                <ul id="treeDemo" style="height: 95%;" class="ztree"></ul>
            </div>
        </div>
        <div class="layui-btn-group" style="float: right;">
            <button type="button" class="layui-btn">确定</button>
        </div>
    </div>
</div>

<script src="../../../static/jquery/jquery.min.js" th:src="@{/jquery/jquery.min.js}"></script>
<script src="../../../static/layuiadmin/layui/layui.js" th:src="@{/layuiadmin/layui/layui.js}"></script>
<script src="../../../static/zTree_v3/js/jquery.ztree.core.min.js"
        th:src="@{/zTree_v3/js/jquery.ztree.core.min.js}"></script>
<script src="../../../static/zTree_v3/js/jquery.ztree.excheck.min.js"
        th:src="@{/zTree_v3/js/jquery.ztree.excheck.min.js}"></script>
<script th:inline="javascript"> var ctx = [[@{
    /}]]; var captchaType = [[${captchaType}]];
</script>
<script th:inline="javascript">
    var zNodes = [];
    var data_id = [[${dataId}]];
    //加载权限树结构数据
    $(function() {
        $.get(ctx + "system/menu/zTreeList", {roleId: data_id}, function (data) {
            var setting = {
                check: {
                    enable: true
                },
                data: {
                    simpleData: {
                        enable: true,
                        pIdKey: "pid"
                    }
                }
            };

            if(data.code == 0) {
                zNodes = data.data;
                console.log(zNodes);
                $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            }
        });
    });


    /** 获取选中的节点 **/
    function getCheckedNodes(treeId) {
        var treeObj = $.fn.zTree.getZTreeObj(treeId);
        var checkedNodes = treeObj.getCheckedNodes();
        var ids = "";
        if(checkedNodes == null || checkedNodes.length == 0) {
            return null;
        }
        for (var i = 0; i < checkedNodes.length; i++) {
            var id = checkedNodes[i].id;
            ids += id + ",";
        }
        return ids.substring(0, ids.length - 1);
    }

    $("#editRole").on('click', function() {
        var roleId = $("#roleId").val();
        var ids = getCheckedNodes("editTree");    //选中的菜单节点
        var roleName = $("#editRoleName").val();
        var remark = $("#editRemark").val();
        if(roleName == null || roleName == "") {
            layer.msg("请输入角色名称");
            return;
        }
        if(ids == null || ids == "") {
            layer.msg("请选择权限");
            return;
        }
        $.post('${webPath}back/rights/editRole', {
            id: roleId,
            ids: ids,
            name: roleName,
            remark: remark
        }, function (data) {
            console.log(data);
            if (data.success) {
                layer.alert(data.msg, function (index) {
                    window.location.reload();
                    layer.close(index);
                });
            }
        })
    });
</script>
</body>
</html>
